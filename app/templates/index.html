<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>CE BOM Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body class="bg-gray-100 p-4">
    <div
      class="max-w-4xl mx-auto bg-white rounded shadow p-4"
      x-data="{ 
        tab: 'review', 
        selectedMode: 'BOM_TipTop_PTC', 
        showModal: false, 
        showSettingModal: false, 
        reviewBomPath: '{{ bom_path }}', 
        importBomPath: '{{ bom_path }}',
        settings: { database_path: '{{ database_path }}', pn_location: '{{ pn_location }}' },
        tempSettings: { database_path: '', pn_location: '' }
      }"
    >
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">CE BOM Tool</h1>
        <button
          class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400"
          @click="tempSettings = { ...settings }; showSettingModal = true"
          type="button"
        >
          參數設定
        </button>
      </div>

      <!-- 固定在上方的區塊 -->
      <div class="mb-4 flex items-center gap-4">
        <div class="flex items-center flex-1">
          <span class="w-28">Database Path:</span>
          <input
            type="text"
            readonly
            disabled
            x-model="settings.database_path"
            class="flex-1 border rounded px-2 py-1"
          />
        </div>
        <div class="flex items-center">
          <span class="w-24">P/N Location:</span>
          <input
            type="text"
            readonly
            disabled
            x-model="settings.pn_location"
            class="w-24 border rounded px-2 py-1"
          />
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex border-b mb-4">
        <button
          :class="tab === 'review' ? 'py-2 px-4 text-blue-700 border-b-2 border-blue-700' : 'py-2 px-4 text-gray-600 hover:text-blue-700'"
          @click="tab = 'review'"
        >
          Review
        </button>
        <button
          :class="tab === 'import' ? 'py-2 px-4 text-blue-700 border-b-2 border-blue-700' : 'py-2 px-4 text-gray-600 hover:text-blue-700'"
          @click="tab = 'import'"
        >
          Import
        </button>
        <button
          :class="tab === 'update' ? 'py-2 px-4 text-blue-700 border-b-2 border-blue-700' : 'py-2 px-4 text-gray-600 hover:text-blue-700'"
          @click="tab = 'update'"
        >
          Update
        </button>
      </div>

      <!-- Review Tab -->
      <div x-show="tab === 'review'" class="tab-content">
        <div class="mb-4">
          <label class="block mb-1">BOM File Path:</label>
          <div class="flex">
            <input
              id="bomPathInput"
              type="text"
              readonly
              x-model="reviewBomPath"
              class="flex-1 border rounded px-2 py-1"
            />
            <button
              class="ml-2 px-2 py-1 bg-gray-200 rounded"
              type="button"
              @click="window.pywebview.api.select_bom_path().then(path => {
                if (path) reviewBomPath = path;
              })"
            >
              ...
            </button>
          </div>
        </div>
        <div class="mb-4">
          <label class="block mb-1">是否區分主替料</label>
          <div class="flex flex-wrap gap-4 items-center">
            <label class="flex items-center">
              <input
                type="radio"
                name="mode"
                value="BOM_TipTop_PTC"
                x-model="selectedMode"
              />
              <span class="ml-1">BOM_TipTop_PTC</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="mode"
                value="Result"
                x-model="selectedMode"
              />
              <span class="ml-1">Result</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="mode"
                value="系統BOM"
                x-model="selectedMode"
              />
              <span class="ml-1">系統BOM</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="mode"
                value="自定義"
                x-model="selectedMode"
              />
              <span class="ml-1">自定義</span>
              <button
                class="ml-1 px-2 py-1 bg-gray-200 rounded"
                :disabled="selectedMode !== '自定義'"
                :class="selectedMode === '自定義' ? 'cursor-pointer bg-blue-500' : 'cursor-not-allowed opacity-50'"
                @click="showModal = true"
                type="button"
              >
                ...
              </button>
            </label>
          </div>
        </div>
        <div class="mb-4">
          <button class="px-4 py-2 bg-blue-600 text-white rounded">
            Start Review
          </button>
        </div>
        <div class="border p-2 rounded bg-gray-50 h-40 overflow-y-auto">
          {{ review_result }}
        </div>
      </div>

      <!-- Import Tab -->
      <div x-show="tab === 'import'" class="tab-content">
        <div class="mb-4">
          <label class="block mb-1">BOM File Path:</label>
          <div class="flex">
            <input
              id="bomPathInput"
              type="text"
              readonly
              x-model="importBomPath"
              class="flex-1 border rounded px-2 py-1"
            />
            <button
              class="ml-2 px-2 py-1 bg-gray-200 rounded"
              type="button"
              @click="window.pywebview.api.select_bom_path().then(path => {
                if (path) importBomPath = path;
              })"
            >
              ...
            </button>
          </div>
        </div>
        <div class="mb-4">
          <button class="px-4 py-2 bg-green-600 text-white rounded">
            Start Import
          </button>
        </div>
        <div class="border p-2 rounded bg-gray-50 h-40 overflow-y-auto">
          {{ import_result }}
        </div>
      </div>

      <!-- Update Tab -->
      <div x-show="tab === 'update'" class="tab-content">
        <div class="mb-4">
          <button class="px-4 py-2 bg-purple-600 text-white rounded">
            Start Update
          </button>
        </div>
        <div class="border p-2 rounded bg-gray-50 h-40 overflow-y-auto">
          {{ update_result }}
        </div>
      </div>

      <!-- 設定參數 Modal -->
      <div
        x-show="showSettingModal"
        x-cloak
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
        style="display: none"
        @click.away="showSettingModal = false"
      >
        <div class="bg-white p-6 rounded shadow w-96" @click.stop>
          <h2 class="text-lg mb-4">參數設定</h2>
          <form class="space-y-2">
            <div>
              <label class="block mb-1">Database Path</label>
              <input
                type="text"
                class="w-full border p-1 rounded"
                placeholder="例如：C:\\Database\\db.sqlite"
                x-model="tempSettings.database_path"
              />
            </div>
            <div>
              <label class="block mb-1">P/N Location</label>
              <input
                type="text"
                class="w-full border p-1 rounded"
                placeholder="例如：B2"
                x-model="tempSettings.pn_location"
              />
            </div>
            <div class="flex justify-end gap-2">
              <button
                type="button"
                class="px-3 py-1 bg-blue-500 text-white rounded"
                @click="settings = { ...tempSettings }; window.pywebview.api.save_settings(settings).then(() => showSettingModal = false)"
              >
                Save
              </button>
              <button
                type="button"
                @click="showSettingModal = false"
                class="px-3 py-1 bg-gray-300 rounded"
              >
                Close
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- 自定義Modal -->
      <div
        x-show="showModal"
        x-cloak
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
        style="display: none"
        @click.away="showModal = false"
      >
        <div class="bg-white p-6 rounded shadow w-96" @click.stop>
          <h2 class="text-lg mb-4">自定義設定</h2>
          <form class="space-y-2">
            <div>
              <label class="block mb-1">Part Number 列名</label>
              <input type="text" class="w-full border p-1 rounded" />
            </div>
            <div>
              <label class="block mb-1">起始行</label>
              <input type="text" class="w-full border p-1 rounded" />
            </div>
            <div class="flex justify-end gap-2">
              <button
                type="button"
                class="px-3 py-1 bg-blue-500 text-white rounded"
                @click="/* 這裡放你 Save 的邏輯 */ showModal = false"
              >
                Save
              </button>
              <button
                type="button"
                @click="showModal = false"
                class="px-3 py-1 bg-gray-300 rounded"
              >
                Close
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
  <script>
    document.addEventListener("alpine:init", () => {
      window.pywebview = window.pywebview || {};
      window.pywebview.api = window.pywebview.api || {};
      if (!window.pywebview.api.select_bom_path) {
        window.pywebview.api.select_bom_path = async () =>
          "/Users/mock/path/to/file.xlsx";
      }
      if (!window.pywebview.api.save_settings) {
        window.pywebview.api.save_settings = async (settings) => {
          console.log("Mock save_settings called with:", settings);
          return Promise.resolve();
        };
      }
    });
  </script>
</html>
